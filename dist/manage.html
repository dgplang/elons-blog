<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Elon Team's Blog</title>
  <!-- <script src="https://cdn.tailwindcss.com"></script> -->
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Mobile Responsive Navigation -->
  <nav class="bg-white shadow p-4 flex justify-between items-center md:flex-row flex-col">
    <h1 class="text-2xl font-bold text-blue-600 mb-2 md:mb-0">Elon Team's Blog</h1>
    <div class="flex flex-wrap gap-2 justify-center">
        <a href="index.html" class="bg-yellow-500 text-white rounded-full px-4 py-2 hover:bg-yellow-600">Home</a>
        <a href="blog.html" class="bg-pink-500 text-white rounded-full px-4 py-2 hover:bg-pink-600">Blog</a>
        <button class="bg-blue-500 text-white rounded-full px-4 py-2 hover:bg-blue-600">Unused</button>
        <button class="bg-green-500 text-white rounded-full px-4 py-2 hover:bg-green-600">Unused</button>
        <button class="bg-purple-500 text-white rounded-full px-4 py-2 hover:bg-purple-600">Unused</button>
        <button id="logoutBtn" class="bg-red-500 text-white rounded-full px-4 py-2 hover:bg-red-600">Logout</button>
    </div>
  </nav>
  <main>
    <!-- Blog Post Update Section -->
    <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-4">Update Blog Post</h2>
    <form id="updateForm" class="bg-white shadow-md rounded p-6 space-y-4">
    <input id="updateId" type="number" placeholder="Updated Post ID" class="w-full border px-4 py-2 rounded" required />
    <input id="updateTitle" type="text" placeholder="Updated Title" class="w-full border px-4 py-2 rounded" required />
    <textarea id="updateContent" placeholder="Updated Content" class="w-full border px-4 py-2 rounded" rows="6" required></textarea>
    <input id="updateCategoryId" type="number" placeholder="Updated Category ID" class="w-full border px-4 py-2 rounded" required />
    <input id="updateImage" type="file" class="w-full border px-4 py-2 rounded" accept="image/*" />
    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Submit Update</button>
    <p id="updateResponseMessage" class="text-sm font-medium"></p>
    </form>
    <section class="p-6">
        <h2 class="text-xl font-bold mb-4">All Blog Posts</h2>
      
        <!-- Filter and Export Controls -->
        <div class="mb-4 flex flex-wrap justify-between items-center gap-4">
          <input
            type="text"
            id="filterInput"
            placeholder="Filter by Title..."
            class="border px-4 py-2 rounded shadow-sm w-full md:w-1/3"
          />
          <button
            onclick="exportToCSV()"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Export to CSV
          </button>
        </div>
      
        <!-- Posts Table -->
        <table class="w-full table-auto border-collapse border border-gray-300" id="allPostsTable">
          <thead class="bg-gray-200">
            <tr>
              <th class="border px-4 py-2">S/N</th>
              <th class="border px-4 py-2">Post ID</th>
              <th class="border px-4 py-2">Title</th>
              <th class="border px-4 py-2">Content</th>
              <th class="border px-4 py-2">Author/User ID</th>
              <th class="border px-4 py-2">Last Updated</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      
        <!-- Pagination Controls -->
        <div class="mt-4 flex justify-center gap-2" id="paginationControls"></div>
    </section>      
    <section class="p-6">
        <h2 class="text-xl font-bold mb-4">All Blog Posts</h2>
        <table class="w-full table-auto border-collapse border border-gray-300" id="allPostsTable">
          <thead class="bg-gray-200">
            <tr>
              <th class="border px-4 py-2">S/N</th>
              <th class="border px-4 py-2">Post ID</th>
              <th class="border px-4 py-2">Title</th>
              <th class="border px-4 py-2">Content</th>
              <th class="border px-4 py-2">Author/User ID</th>
              <th class="border px-4 py-2">Last Updated</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>      
  </main>
<script>
    const rowsPerPage = 5;
    let currentPage = 1;
    let filteredPosts = [];

    function getFormattedPosts() {
        const posts = [];

        for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);

        if (key.startsWith("Post_")) {
            const post = JSON.parse(localStorage.getItem(key));

            const formattedDate = new Date(post.updated_at).toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric"
            });

            posts.push({
            id: post.id,
            title: post.title,
            content: post.content,
            user_id: post.user_id,
            updated: formattedDate
            });
        }
        }

        return posts;
    }

    function displayStoredPosts() {
        const tableBody = document.querySelector("#allPostsTable tbody");
        tableBody.innerHTML = "";

        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const postsToDisplay = filteredPosts.slice(startIndex, endIndex);

        postsToDisplay.forEach((post, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="border px-4 py-2 text-center">${startIndex + index + 1}</td>
            <td class="border px-4 py-2">${post.id}</td>
            <td class="border px-4 py-2">${post.title}</td>
            <td class="border px-4 py-2">${post.content}</td>
            <td class="border px-4 py-2">${post.user_id}</td>
            <td class="border px-4 py-2">${post.updated}</td>
        `;
        tableBody.appendChild(row);
        });

        renderPaginationControls();
    }

    function renderPaginationControls() {
        const paginationContainer = document.getElementById("paginationControls");
        paginationContainer.innerHTML = "";

        const totalPages = Math.ceil(filteredPosts.length / rowsPerPage);

        for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = `px-3 py-1 border rounded ${i === currentPage ? "bg-blue-600 text-white" : "bg-white text-blue-600"}`;
        btn.onclick = () => {
            currentPage = i;
            displayStoredPosts();
        };
        paginationContainer.appendChild(btn);
        }
    }

    function filterPosts() {
        const query = document.getElementById("filterInput").value.toLowerCase();
        filteredPosts = getFormattedPosts().filter(post =>
        post.title.toLowerCase().includes(query)
        );
        currentPage = 1;
        displayStoredPosts();
    }

    document.getElementById("filterInput").addEventListener("input", filterPosts);

    function exportToCSV() {
        let csv = "S/N,Post ID,Title,Content,User ID,Last Updated\n";
        filteredPosts.forEach((post, index) => {
        csv += `"${index + 1}","${post.id}","${post.title.replace(/"/g, '""')}","${post.content.replace(/"/g, '""')}","${post.user_id}","${post.updated}"\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "blog_posts.csv";
        link.click();
    }

    window.onload = () => {
        filteredPosts = getFormattedPosts();
        displayStoredPosts();
    };

    const updateForm = document.getElementById("updateForm");
    const updateResponseMessage = document.getElementById("updateResponseMessage");

    // Populate update form when "Update" button is clicked
    function updatePost(postId) {
    const postData = JSON.parse(localStorage.getItem(`Post_${postId}`));
    if (!postData) {
        alert("Post not found in localStorage.");
        return;
    }

    document.getElementById("updateId").value = postData.id;
    document.getElementById("updateTitle").value = postData.title;
    document.getElementById("updateContent").value = postData.content;
    document.getElementById("updateCategoryId").value = postData.category_id;
    }

    // Submit updated data to API
    updateForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const postId = document.getElementById("updateId").value;
    const title = document.getElementById("updateTitle").value.trim();
    const content = document.getElementById("updateContent").value.trim();
    const categoryId = document.getElementById("updateCategoryId").value.trim();
    const image = document.getElementById("updateImage").files[0];

    const formData = new FormData();
    formData.append("title", title);
    formData.append("content", content);
    formData.append("category_id", parseInt(categoryId));
    if (image) {
        formData.append("featured_image", image);
    }

    const loggedInEmail = localStorage.getItem("loggedInEmail");
    const userData = localStorage.getItem(loggedInEmail);
    if (!userData) {
        updateResponseMessage.textContent = "❌ User data not found.";
        updateResponseMessage.style.color = "red";
        return;
    }

    const user = JSON.parse(userData);
    const token = user.token;

    fetch(`https://test.blockfuselabs.com/api/posts/${postId}`, {
        method: "PATCH",
        headers: {
        Authorization: `Bearer ${token}`,
        },
        body: formData,
    })
        .then((response) => {
        if (response.status === 200) {
            return response.json();
        } else {
            return response.text().then((text) => {
            throw new Error(`❌ Error ${response.status}: ${text}`);
            });
        }
        })
        .then((updatedPost) => {
        // ✅ Save to localStorage
        localStorage.setItem(`Post_${updatedPost.id}`, JSON.stringify(updatedPost));

        // ✅ Update UI
        updateResponseMessage.textContent = "✅ Post updated successfully!";
        updateResponseMessage.style.color = "green";

        // Optionally refresh the posts table
        //displayStoredPosts();

        updateForm.reset();
        })
        .catch((error) => {
        updateResponseMessage.textContent = error.message;
        updateResponseMessage.style.color = "red";
        });
    });

    function displayStoredPosts() {
        const tableBody = document.querySelector("#allPostsTable tbody");
        tableBody.innerHTML = ""; // Clear previous rows

        let serial = 1;

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);

            if (key.startsWith("Post_")) {
            const post = JSON.parse(localStorage.getItem(key));

            // Format the updated_at date (e.g., "2025-05-20T13:22:00Z" => "May 20, 2025")
            const updatedDate = new Date(post.updated_at);
            const formattedDate = updatedDate.toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric"
            });

            const row = document.createElement("tr");
            row.innerHTML = `
                <td class="border px-4 py-2 text-center">${serial++}</td>
                <td class="border px-4 py-2">${post.id}</td>
                <td class="border px-4 py-2">${post.title}</td>
                <td class="border px-4 py-2">${post.content}</td>
                <td class="border px-4 py-2">${post.user_id}</td>
                <td class="border px-4 py-2">${formattedDate}</td>
            `;

            tableBody.appendChild(row);
            }
        }
    }

    function deletePost(postId) {
        const key = `Post_${postId}`;
        if (localStorage.getItem(key)) {
            if (confirm("Are you sure you want to delete this post?")) {
            localStorage.removeItem(key);
            displayStoredPosts(); // Refresh the table
            }
        } else {
            alert("Post not found.");
        }
    }

    window.onload = () => {
        displayStoredPosts();
    }

    const logoutBtn = document.getElementById("logoutBtn");

    logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();

        // Step 1: Get the logged-in email
        const email = localStorage.getItem("loggedInEmail");

        if (email) {
        // Step 2: Get the user object from localStorage
        const userData = localStorage.getItem(email);

        if (userData) {
            const user = JSON.parse(userData);

            // Step 3: Update isLog to false
            user.isLog = false;

            // Step 4: Save the updated user back to localStorage
            localStorage.setItem(email, JSON.stringify(user));

            // Optional: remove loggedInEmail
            localStorage.removeItem("loggedInEmail");

            // Step 5: Redirect after a short delay
            setTimeout(() => {
            window.location.href = "index.html";
            }, 2000); // 2 seconds
        }
        }
    });
</script>
</body>
</html>