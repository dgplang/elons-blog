<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Details - Elon Team's Blog</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
    <style>
        .error { color: red; text-align: center; font-size: 1rem; margin: 10px 0; }
        .label-bold { font-weight: 700; }
        .value-normal { font-weight: 400; }
        .skeleton { background-color: #e5e7eb; border-radius: 4px; }
        .pulse { animation: pulse 1.5s infinite ease-in-out; }
        .no-posts { color: #374151; text-align: center; font-size: 1rem; margin: 10px 0; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="m-0 p-0 box-border">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 w-full bg-[#f7f7f7] shadow-md z-50">
        <div class="container mx-auto px-5 md:px-20 py-3 flex items-center justify-between">
            <div class="logo">
                <a href="index.html">
                    <img src="media/logo.jpeg" alt="Elon Team Blog" class="w-1/6 md:w-1/4 logo-tint">
                </a>
            </div>
            <button id="menu" class="md:hidden text-gray-700 focus:outline-none w-6 h-6">
                <i class='bx bx-menu block text-2xl'></i>
                <i class='bx bx-x hidden text-2xl'></i>
            </button>
            <ul id="nav-links" class="hidden md:flex space-x-6 items-center">
                <li><a href="index.html" class="text-[#0c4c8a] hover:text-[#1f3750] hover:border-b-2 border-[#0c4c8a]">Home</a></li>
                <li><a href="blog.html" class="text-[#0c4c8a] hover:text-[#1f3750] hover:border-b-2 border-[#0c4c8a]">Blog</a></li>
                <li><a href="create.html" class="text-[#0c4c8a] hover:text-[#1f3750] hover:border-b-2 border-[#0c4c8a] member">Manage Blog</a></li>
                <li><a href="contact.html" class="text-[#0c4c8a] hover:text-[#1f3750] hover:border-b-2 border-[#0c4c8a]">Contact</a></li>
            </ul>
            <div id="myBtn" class="hidden md:flex space-x-4">
                <a href="login.html" class="px-4 py-2 bg-[#0c4c8a] hover:bg-[#1f3750] text-white rounded-md nonuser">Login</a>
                <a href="registration.html" class="px-4 py-2 bg-[#0c4c8a] hover:bg-[#1f3750] text-white rounded-md nonuser">Get Started</a>
                <a href="login.html" class="px-4 py-2 bg-[#0c4c8a] hover:bg-[#1f3750] text-white rounded-md user">Logout</a>
            </div>
        </div>
        <div id="mobileMenu" class="md:hidden px-4 pb-4 hidden flex-col">
            <ul class="space-y-2">
                <li><a href="index.html" class="text-[#0c4c8a] hover:text-[#1f3750] hover:border-b-2 border-[#0c4c8a]">Home</a></li>
                <li><a href="blog.html" class="text-[#0c4c8a] hover:text-[#1f3750] hover:border-b-2 border-[#0c4c8a]">Blog</a></li>
                <li><a href="create.html" class="text-[#0c4c8a] hover:text-[#1f3750] hover:border-b-2 border-[#0c4c8a] member">Manage Blog</a></li>
                <li><a href="contact.html" class="text-[#0c4c8a] hover:text-[#1f3750] hover:border-b-2 border-[#0c4c8a]">Contact</a></li>
            </ul>
            <div class="pt-4 space-y-2">
                <a href="login.html" class="px-4 py-2 bg-[#0c4c8a] hover:bg-[#1f3750] text-white rounded-md nonuser">Login</a>
                <a href="registration.html" class="px-4 py-2 bg-[#0c4c8a] hover:bg-[#1f3750] text-white rounded-md nonuser">Get Started</a>
                <a href="login.html" class="px-4 py-2 bg-[#0c4c8a] hover:bg-[#1f3750] text-white rounded-md user">Logout</a>
            </div>
        </div>
    </nav>

    <main class="pt-20 md:pt-24">
        <div class="flex flex-col items-center">
            <div class="flex flex-col md:flex-row items-center md:items-start justify-between my-6 md:my-0 mx-5 md:mx-20">
                <div class="flex flex-col p-0 m-0 w-full md:w-3/4">
                    <div class="w-full text-2xl md:text-3xl font-semibold text-gray-700 pb-6" id="blogtitle">
                        <div class="skeleton pulse h-8 w-3/4"></div>
                    </div>
                    <div class="flex flex-col sm:flex-row md:flex-row justify-start xs:text-xs sm:text-sm md:text-base font-light text-gray-800 gap-2 pt-3">
                        <p><span class="label-bold">Author:</span> <span id="authorName" class="value-normal"><span class="skeleton pulse inline-block h-4 w-24"></span></span></p>
                        <p><span class="label-bold">Last updated:</span> <span id="lastUpdated" class="value-normal"><span class="skeleton pulse inline-block h-4 w-24"></span></span></p>
                    </div>
                    <div class="w-full overflow-hidden my-4">
                        <span id="postImage">
                            <div class="skeleton pulse w-full h-60 md:h-96"></div>
                        </span>
                    </div>
                    <div class="w-full xs:text-sm sm:text-base md:text-lg text-justify leading-relaxed" id="blogpost">
                        <div class="space-y-2">
                            <div class="skeleton pulse h-4 w-full"></div>
                            <div class="skeleton pulse h-4 w-5/6"></div>
                            <div class="skeleton pulse h-4 w-4/5"></div>
                            <div class="skeleton pulse h-4 w-3/4"></div>
                        </div>
                    </div>
                    <div class="w-full mx-auto my-6 p-4 sm:p-6 bg-[#0c4c8a] rounded-lg shadow-lg">
                        <div class="mb-6">
                            <h2 class="text-xl sm:text-2xl font-semibold text-white mb-4">Leave a Comment</h2>
                            <form class="space-y-4">
                                <div>
                                    <label for="comment" class="block text-sm font-medium text-white">Add Comment</label>
                                    <textarea
                                        id="commentInput"
                                        rows="4"
                                        class="mt-1 w-full p-3 rounded-md border border-gray-300 bg-white text-[#26355b] focus:ring-[#89d7de] focus:border-[#89d7de] text-sm sm:text-base"
                                        placeholder="Write your comment here..."
                                        required
                                    ></textarea>
                                </div>
                                <button id="postCommentBtn"
                                    type="submit"
                                    class="w-full sm:w-auto px-6 py-2 bg-[#64fcfd] text-[#26355b] rounded-md hover:bg-[#26355b] hover:text-white transition-colors text-sm sm:text-base"
                                >
                                    Post Comment
                                </button>
                            </form>
                            <p id="commentResponse"></p>
                        </div>
                        <div>
                            <h2 class="text-xl sm:text-2xl font-semibold text-white mb-4">Comments</h2>
                            <div id="commentsContainer" class="space-y-4">
                                <div class="p-4 bg-white rounded-md shadow-sm">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="skeleton pulse h-4 w-24"></div>
                                        <div class="skeleton pulse h-3 w-16"></div>
                                    </div>
                                    <div class="skeleton pulse h-4 w-full"></div>
                                    <div class="skeleton pulse h-4 w-5/6 mt-1"></div>
                                </div>
                                <div class="p-4 bg-white rounded-md shadow-sm">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="skeleton pulse h-4 w-24"></div>
                                        <div class="skeleton pulse h-3 w-16"></div>
                                    </div>
                                    <div class="skeleton pulse h-4 w-full"></div>
                                    <div class="skeleton pulse h-4 w-5/6 mt-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full md:w-1/4">
                    <div class="ml-0 md:ml-4 max-w-2xl mx-auto px-4 bg-[#00fffc] border border-[#0c4c8a] rounded-md">
                        <h2 class="font-bold text-[#124386] text-center text-2xl py-2 px-4 rounded-lg">Categories</h2>
                        <select name="category" id="category_id" class="mt-2 w-full text-gray-800 font-semibold block border border-gray-600 rounded-md px-4 py-2 mb-3"></select>
                        <div class="flex justify-center items-center">
                            <button id="showPostsBtn" class="px-6 py-2 mb-4 text-center font-semibold text-white bg-[#0c4c8a] rounded-md hover:bg-[#1f3750] transition-colors">Show</button>
                        </div>
                    </div>
                    <div class="pb-1 pl-0 md:pl-4 pt-2 w-full text-2xl font-normal">Category Posts</div>
                    <div class="pl-0 md:pl-4">
                        <div id="relatedPosts" class="flex flex-col">
                            <p class="no-posts">Select a category to view posts.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="bg-[#0c4c8a] hover:bg-[#1f3750] py-3">
        <div class="text-white text-center">
            <span>© Blockfuse Labs, The Elon Team, Cohort 2 Web2 Beginners, 2025.</span>
            <p><a href="https://github.com/dgplang/elons-blog-project" target="_blank" class="hover:underline text-white">GitHub Link</a></p>
        </div>
    </footer>
    <script>
        // Capitalize first letters of names
        function capitalizeWords(str) {
            return str.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        const getPostDetails = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            if (!id || isNaN(id)) {
                console.error('❌ No valid post ID provided in URL');
                document.getElementById('blogtitle').innerHTML = '';
                document.getElementById('authorName').innerHTML = '';
                document.getElementById('lastUpdated').innerHTML = '';
                document.getElementById('postImage').innerHTML = '';
                document.getElementById('blogpost').innerHTML = '<p class="error">No valid post ID provided.</p>';
                return;
            }

            fetch(`https://test.blockfuselabs.com/api/posts/${id}`, {
                method: 'GET',
                headers: { 'Accept': '*/*' }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('✅ Post details fetched:', data);
                const formatDate = (isoDate) => {
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    return new Date(isoDate).toLocaleDateString(undefined, options);
                };

                document.getElementById('blogtitle').textContent = data.title || 'Untitled Post';
                document.getElementById('blogpost').innerHTML = data.content || '<p>No content available.</p>';
                document.getElementById('authorName').textContent = data.user && data.user.name ? capitalizeWords(data.user.name) : 'Unknown Author';
                document.getElementById('lastUpdated').textContent = data.updated_at ? formatDate(data.updated_at) : 'Unknown Date';
                document.getElementById('postImage').innerHTML = data.featured_image_url_full || data.slug ?
                    `<img src="${data.featured_image_url_full || 'https://via.placeholder.com/300'}" alt="${data.slug || 'Post Image'}" class="w-full h-60 md:h-96 object-cover">` : '';
            })
            .catch(error => {
                console.error('❌ Error fetching post details:', error.message);
                document.getElementById('blogtitle').innerHTML = '';
                document.getElementById('authorName').innerHTML = '';
                document.getElementById('lastUpdated').innerHTML = '';
                document.getElementById('postImage').innerHTML = '';
                document.getElementById('blogpost').innerHTML = `<p class="error">Error loading post: ${error.message}</p>`;
            });
        };

        function loadComments(postId) {
            const commentsContainer = document.getElementById('commentsContainer');

            fetch(`https://test.blockfuselabs.com/api/posts/${postId}/comments`, {
                method: 'GET',
                headers: { 'Accept': '*/*' }
            })
            .then(response => response.json())
            .then(comments => {
                commentsContainer.innerHTML = '';
                if (comments.length === 0) {
                    commentsContainer.innerHTML = '<p class="text-white">No comments yet.</p>';
                    return;
                }
                comments.forEach(comment => {
                    const commentBlock = document.createElement('div');
                    commentBlock.className = 'p-4 bg-white rounded-md shadow-sm animate-comment';
                    const time = new Date(comment.created_at).toLocaleString('en-US', {
                        dateStyle: 'medium',
                        timeStyle: 'short'
                    });
                    commentBlock.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm sm:text-base font-medium text-[#26355b]">${capitalizeWords(comment.user.name)}</h3>
                            <span class="text-xs sm:text-sm text-gray-500">${time}</span>
                        </div>
                        <p class="text-sm sm:text-base text-[#26355b] text-justify leading-tight">${comment.content}</p>
                    `;
                    commentsContainer.appendChild(commentBlock);
                });
            })
            .catch(error => {
                console.error('Error fetching comments:', error);
                commentsContainer.innerHTML = '<p class="error">Failed to load comments.</p>';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');

            if (!postId || isNaN(postId)) {
                console.error('❌ No valid post ID provided');
                document.getElementById('blogtitle').innerHTML = '';
                document.getElementById('authorName').innerHTML = '';
                document.getElementById('lastUpdated').innerHTML = '';
                document.getElementById('postImage').innerHTML = '';
                document.getElementById('blogpost').innerHTML = '<p class="error">No valid post ID provided.</p>';
                document.getElementById('commentsContainer').innerHTML = '<p class="error">Cannot load comments: No valid post ID.</p>';
                document.getElementById('relatedPosts').innerHTML = '<p class="error">Cannot load posts: No valid post ID.</p>';
                return;
            }

            getPostDetails();
            loadComments(postId);

            const commentInput = document.getElementById('commentInput');
            const responseMessage = document.getElementById('commentResponse');
            const postButton = document.getElementById('postCommentBtn');
            const categorySelect = document.getElementById('category_id');
            const showPostsBtn = document.getElementById('showPostsBtn');
            const relatedPostsContainer = document.getElementById('relatedPosts');

            postButton.addEventListener('click', (event) => {
                event.preventDefault();

                const userData = localStorage.getItem('loggedInEmail');
                if (!userData) {
                    responseMessage.textContent = '❌ User not logged in.';
                    responseMessage.className = 'error';
                    return;
                }

                const user = JSON.parse(localStorage.getItem(userData));
                if (!user || !user.email) {
                    responseMessage.textContent = '❌ User session is invalid or expired.';
                    responseMessage.className = 'error';
                    return;
                }

                const token = user.token;
                const commentContent = commentInput.value.trim();

                if (!commentContent) {
                    responseMessage.textContent = '❌ Please enter a comment.';
                    responseMessage.className = 'error';
                    return;
                }

                const commentData = { content: commentContent };
                console.log('📤 Sending comment:', commentData);

                fetch(`https://test.blockfuselabs.com/api/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(commentData)
                })
                .then(response => {
                    console.log('📩 Raw response received:', response);
                    if (response.status === 201) {
                        return response.json();
                    }
                    return response.text().then(text => {
                        throw new Error(`❌ Error ${response.status}: ${text}`);
                    });
                })
                .then(data => {
                    commentInput.value = '';
                    responseMessage.textContent = '✅ Comment posted successfully!';
                    responseMessage.className = 'text-green-500';

                    const commentsContainer = document.getElementById('commentsContainer');
                    const commentBlock = document.createElement('div');
                    commentBlock.className = 'p-4 bg-white rounded-md shadow-sm animate-comment';
                    const time = new Date(data.created_at).toLocaleString('en-US', {
                        dateStyle: 'medium',
                        timeStyle: 'short'
                    });
                    commentBlock.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm sm:text-base font-medium text-[#26355b]">${capitalizeWords(data.user.name)}</h3>
                            <span class="text-xs sm:text-sm text-gray-500">${time}</span>
                        </div>
                        <p class="text-sm sm:text-base text-[#26355b] text-justify leading-tight">${data.content}</p>
                    `;
                    commentsContainer.prepend(commentBlock);

                    setTimeout(() => {
                        responseMessage.textContent = '';
                    }, 3000);
                })
                .catch(error => {
                    console.error('❌ Error during fetch:', error.message);
                    responseMessage.textContent = error.message;
                    responseMessage.className = 'error';
                });
            });

            const fetchCategories = (url) => {
                let allCategories = [];
                const getPage = (pageUrl) => {
                    fetch(pageUrl, {
                        method: 'GET',
                        headers: { 'Accept': '*/*' }
                    })
                    .then(res => {
                        if (!res.ok) throw new Error('Network response was not ok');
                        return res.json();
                    })
                    .then(data => {
                        allCategories = allCategories.concat(data.data);
                        if (data.next_page_url) {
                            getPage(data.next_page_url);
                        } else {
                            const chooseOption = document.createElement('option');
                            chooseOption.value = '';
                            chooseOption.disabled = true;
                            chooseOption.selected = true;
                            chooseOption.textContent = 'Choose';
                            categorySelect.appendChild(chooseOption);
                            allCategories.forEach(category => {
                                const option = document.createElement('option');
                                option.value = category.id;
                                option.textContent = category.name;
                                categorySelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching categories:', error);
                        const errorOption = document.createElement('option');
                        errorOption.disabled = true;
                        errorOption.textContent = '❌ Failed to load categories';
                        categorySelect.appendChild(errorOption);
                    });
                };
                getPage(url);
            };

            const fetchPostsByCategory = (categoryId) => {
                relatedPostsContainer.innerHTML = `
                    <div class="w-full leading-relaxed flex items-center">
                        <div class="flex items-center w-full">
                            <div class="skeleton pulse w-16 h-16"></div>
                            <div class="p-3 flex-1">
                                <div class="skeleton pulse h-4 w-3/4"></div>
                            </div>
                        </div>
                    </div>
                    <div class="w-full leading-relaxed flex items-center">
                        <div class="flex items-center w-full">
                            <div class="skeleton pulse w-16 h-16"></div>
                            <div class="p-3 flex-1">
                                <div class="skeleton pulse h-4 w-3/4"></div>
                            </div>
                        </div>
                    </div>
                `;

                let allPosts = [];
                const fetchPage = (url) => {
                    fetch(url, {
                        method: 'GET',
                        headers: { 'Accept': '*/*' }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Raw API response:', data);
                        allPosts = allPosts.concat(data.data || []);
                        if (data.next_page_url) {
                            fetchPage(data.next_page_url);
                        } else {
                            relatedPostsContainer.innerHTML = '';
                            const posts = allPosts
                                .filter(post => {
                                    const categoryMatch = (
                                        post.category_id == categoryId ||
                                        post.category?.id == categoryId ||
                                        (Array.isArray(post.categories) && post.categories.some(cat => cat.id == categoryId))
                                    );
                                    const teamMatch = post.user?.team_name === 'Elon';
                                    console.log(`Post ${post.id} - Category match: ${categoryMatch}, Team match: ${teamMatch}`);
                                    return categoryMatch && teamMatch;
                                })
                                .filter(post => post.id != postId); // Exclude current post
                            console.log('Filtered posts:', posts);
                            if (posts.length === 0) {
                                relatedPostsContainer.innerHTML = '<p class="no-posts">No posts found for this category.</p>';
                                return;
                            }
                            posts.forEach(post => {
                                const postElement = document.createElement('div');
                                postElement.className = 'w-full leading-relaxed hover:underline flex items-center';
                                postElement.innerHTML = `
                                    <a href="detail.html?id=${post.id}" target="_self" class="flex items-center">
                                        <img src="${post.featured_image_url_full || 'https://via.placeholder.com/150'}" alt="${post.slug || 'Post thumbnail'}" class="w-16 h-16 object-cover">
                                        <div class="p-3 flex-1">
                                            <h3 class="text-base font-semibold text-gray-800 line-clamp-3">${post.title}</h3>
                                        </div>
                                    </a>
                                `;
                                relatedPostsContainer.appendChild(postElement);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching posts:', error);
                        relatedPostsContainer.innerHTML = `<p class="error">Failed to load posts: ${error.message}</p>`;
                    });
                };

                fetchPage(`https://test.blockfuselabs.com/api/posts?category_id=${categoryId}`);
            };

            showPostsBtn.addEventListener('click', () => {
                const selectedCategoryId = categorySelect.value;
                if (!selectedCategoryId) {
                    relatedPostsContainer.innerHTML = '<p class="error">Please select a category.</p>';
                    return;
                }
                fetchPostsByCategory(selectedCategoryId);
            });

            fetchCategories('https://test.blockfuselabs.com/api/categories');
        });
    </script>
    <script src="script.js"></script>
</body>
</html>